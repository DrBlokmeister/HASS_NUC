homeassistant:
  customize:
    sensor.speedtest_download:
      templates:
        icon: >
          if (state > 800) return 'mdi:speedometer';
          if (state > 500) return 'mdi:speedometer-medium';
          return 'mdi:speedometer-slow'
        icon_color: >
          var maxval = 1000;
          var minval = 400;
          var maxhue = 120;
          var minhue = 0;
          if (state > maxval) return 'hsl(' + maxhue.toString() + ',80%,50%)';
          if (state < minval) return 'hsl(' + minhue.toString() + ',80%,50%)';
          var hue = Math.round((Number(state) - minval) / (maxval - minval) * (maxhue - minhue) + minhue );
          return 'hsl(' + hue.toString() + ',80%,50%)';
    sensor.speedtest_upload:
      icon: mdi:speedometer
      templates:
        icon: >
          if (state > 800) return 'mdi:speedometer';
          if (state > 500) return 'mdi:speedometer-medium';
          return 'mdi:speedometer-slow'
        icon_color: >
          var maxval = 1000;
          var minval = 400;
          var maxhue = 120;
          var minhue = 0;
          if (state > maxval) return 'hsl(' + maxhue.toString() + ',80%,50%)';
          if (state < minval) return 'hsl(' + minhue.toString() + ',80%,50%)';
          var hue = Math.round((Number(state) - minval) / (maxval - minval) * (maxhue - minhue) + minhue );
          return 'hsl(' + hue.toString() + ',80%,50%)';
    sensor.speedtest_ping:
      icon: mdi:speedometer
      templates:
        icon_color: >
          var maxval = 30;
          var minval = 1;
          var maxhue = 0;
          var minhue = 120;
          if (state > maxval) return 'hsl(' + maxhue.toString() + ',80%,50%)';
          if (state < minval) return 'hsl(' + minhue.toString() + ',80%,50%)';
          var hue = Math.round((Number(state) - minval) / (maxval - minval) * (maxhue - minhue) + minhue );

#################
#    SENSORS    #
#################
sensor:
  - platform: template
    sensors:
      ping_router_avg:
        value_template: "{{ state_attr('binary_sensor.udm_pro', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "Router ping average"
        availability_template: "{{ state_attr('binary_sensor.udm_pro', 'round_trip_time_avg')|is_number }}"

      ping_blokmeisternas_avg:
        value_template: "{{ state_attr('binary_sensor.blokmeisternas', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "BlokmeisterNAS ping average"
        availability_template: "{{ state_attr('binary_sensor.blokmeisternas', 'round_trip_time_avg')|is_number }}"

      ping_phone_avg:
        value_template: "{{ state_attr('binary_sensor.phone', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "Phone ping average"
        availability_template: "{{ state_attr('binary_sensor.phone', 'round_trip_time_avg')|is_number }}"

      ping_odroid_c2_avg:
        value_template: "{{ state_attr('binary_sensor.odroid_c2', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "Odroid C2 ping average"
        availability_template: "{{ state_attr('binary_sensor.odroid_c2', 'round_trip_time_avg')|is_number }}"

      ping_ambilight_rpi_avg:
        value_template: "{{ state_attr('binary_sensor.ambilight_rpi', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "Ambilight RPI ping average"
        availability_template: "{{ state_attr('binary_sensor.ambilight_rpi', 'round_trip_time_avg')|is_number }}"

      ping_snlr_avg:
        value_template: "{{ state_attr('binary_sensor.snlr', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "Plinq ping average"
        availability_template: "{{ state_attr('binary_sensor.snlr', 'round_trip_time_avg')|is_number }}"

      ping_google_dns_avg:
        value_template: "{{ state_attr('binary_sensor.google_dns', 'round_trip_time_avg')|round(2) }}"
        unit_of_measurement: ms
        friendly_name: "Google DNS ping average"
        availability_template: "{{ state_attr('binary_sensor.google_dns', 'round_trip_time_avg')|is_number }}"

      udmp_download_speed_mbs:
        value_template: "{{ (states('sensor.unifi_dream_machine_kib_s_received')|float/1024)|round(1) }}"
        unit_of_measurement: MB/s
        friendly_name: "Router Download Speed"
        availability_template: "{{ states('sensor.unifi_dream_machine_kib_s_received')|is_number }}"
      udmp_upload_speed_mbs:
        value_template: "{{ (states('sensor.unifi_dream_machine_kib_s_sent')|float/1024)|round(1) }}"
        unit_of_measurement: MB/s
        friendly_name: "Router Download Speed"
        availability_template: "{{ states('sensor.unifi_dream_machine_kib_s_sent')|is_number }}"
      udmp_download_gb:
        value_template: "{{ (states('sensor.unifi_dream_machine_b_received')|float/1024**3)|round(1) }}"
        unit_of_measurement: GB
        friendly_name: "Router Total Download"
        availability_template: "{{ states('sensor.unifi_dream_machine_b_received')|is_number }}"
      udmp_upload_gb:
        value_template: "{{ (states('sensor.unifi_dream_machine_b_sent')|float/1024**3)|round(1) }}"
        unit_of_measurement: GB
        friendly_name: "Router Total Upload"
        availability_template: "{{ states('sensor.unifi_dream_machine_b_sent')|is_number }}"

  - platform: statistics
    entity_id: sensor.asuswrt_download_speed
    name: Average download
    precision: 2
    sampling_size: 60
    max_age:
      minutes: 60

  - platform: statistics
    entity_id: sensor.asuswrt_upload_speed
    name: Average upload
    precision: 2
    sampling_size: 60
    max_age:
      minutes: 60

########################
#    BINARY SENSORS    #
########################
binary_sensor:
  - platform: ping
    name: BlokmeisterNAS
    host: tower.local
    count: 10
    scan_interval: 60
  - platform: ping
    name: UDM Pro
    host: unifi.local
    count: 10
    scan_interval: 60
  - platform: ping
    name: Phone
    host: 10.0.0.100
    count: 10
    scan_interval: 60
  - platform: ping
    name: Odroid_C2
    host: CoreELEC.local
    count: 10
    scan_interval: 60
  - platform: ping
    name: Ambilight_RPI
    host: HyperBian.local
    count: 10
    scan_interval: 60
  - platform: ping
    name: SNLR
    host: 45.145.109.105
    count: 10
    scan_interval: 60
  - platform: ping
    name: Google_DNS
    host: 8.8.8.8
    count: 10
    scan_interval: 60
  - platform: ping
    name: Blokmeisterdesktop
    host: 10.0.0.101
    count: 10
    scan_interval: 60

##################
#    SWITCHES    #
##################
switch:

#####################
#    AUTOMATIONS    #
#####################
automation:
#Send a notification to Ariela when the a torrent is completed
  - alias: 'Completed Torrent'
    trigger:
      platform: event
      event_type: transmission_downloaded_torrent
    action:
      service: notify.mobile_app_blokmeisters21u
      data:
        title: "Torrent completed!"
        message: "{{ trigger.event.data.name }} has finished downloading!"
        data:
          group: reminder
          tag: transmission
          icon_url: "https://upload.wikimedia.org/wikipedia/commons/6/6d/Transmission_icon.png"
          timeout: 1800

  - alias: '[network|notify]Alert phone when network speed is too low'
    trigger:
      - platform: numeric_state
        entity_id: sensor.speedtest_download
        below: 100
        for:
          minutes: 70
    action:
      service: notify.mobile_app_blokmeisters21u
      data:
        title: "Network speed 100mbit!"
        message: "Current network speed {{ states('sensor.speedtest_download') }} Mbit/s."
        data:
          group: reminder
          tag: networkspeed
          timeout: 1800
################
#    SCENES    #
################
scene:

################
#    GROUPS    #
################
group:

#################
#    SCRIPTS    #
#################
script:
  transmission_message_download_completed:
      alias: "Message phone about completed torrent"
      sequence:
        - service: notify.mobile_app_blokmeisters21u
          data:
            message: "A torrent is done downloading"
            title: "Home Assistant - Transmission"
            data:
              group: reminder
              tag: transmission
              icon_url: "https://upload.wikimedia.org/wikipedia/commons/6/6d/Transmission_icon.png"
              timeout: 1800

  # message_transmission_not_reachable:
  #     alias: "Contact to transmission lost"
  #     sequence:
  #       - service: notify.mobile_app_blokmeister_op6
  #         data:
  #           message: "The contact to Transmission has been lost"
  #           title: "Home Assistant - Transmission"
  #           data:
  #             icon: "http://wfarm2.dataknet.com/static/resources/icons/set92/b8ef5c32.png"
  #             image: "https://upload.wikimedia.org/wikipedia/commons/6/6d/Transmission_icon.png"

  # message_odroid_not_reachable:
  #     alias: "Contact to Odroid C2 lost"
  #     sequence:
  #       - service: notify.mobile_app_blokmeister_op6
  #         data:
  #           message: "The contact to the Odroid C2 has been lost"
  #           title: "Home Assistant - Odroid C2"
  #           data:
  #             icon: mdi:library-movie
  #             image: mdi_library-movie
