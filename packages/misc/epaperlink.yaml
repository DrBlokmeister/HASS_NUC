########## REFERENCES ##########
# 00000218736e3b1e #Study Climate
# 0000021dbca73412 #Moeke Water Reservoir
# 0000039223703418 #Study Energy
# garbage_monitor_tag #Garbage Monitor
# 0000021c3bc6341b #Washing Machine Energy
# 0000021d26a23414 #Litterbox
# 00007e22b1d7b299 #Washroom Electricity Price
# 00007e225dc2b29f #Study Electricity Price
# 00007e22b1b2b29a #Kitchen Electricity Price

homeassistant:
  customize: {}

template:
  - trigger:
      - platform: time_pattern
        seconds: "/20"
    sensor:
      - name: "Median Epaper Tag Last Check-In Time"
        device_class: timestamp
        unique_id: yaml_template_sensor_median_epaper_tag_last_check_in_time
        icon: mdi:clock-in
        state: >
          {% set ns = namespace(times=[]) %}
          {%- for sensor in [
            'sensor.00000218736e3b1e_last_seen',
            'sensor.0000021dbca73412_last_seen',
            'sensor.0000039223703418_last_seen',
            'sensor.garbage_monitor_tag_last_seen',
            'sensor.0000021c3bc6341b_last_seen',
            'sensor.0000021d26a23414_last_seen',
            'sensor.00007e22b1d7b299_last_seen',
            'sensor.00007e225dc2b29f_last_seen',
            'sensor.00007e22b1b2b29a_last_seen'
          ] -%}
            {%- if states(sensor) not in ['unknown', 'unavailable', 'none', ''] -%}
              {%- set timestamp = as_timestamp(states(sensor)) -%}
              {%- if timestamp is not none -%}
                {%- set ns.times = ns.times + [timestamp] -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if ns.times | length > 0 -%}
            {%- set ns.times = ns.times | sort -%}
            {%- set mid = ns.times | length // 2 -%}
            {%- if ns.times | length is odd -%}
              {{ (ns.times[mid] | as_datetime | as_local).isoformat() }}
            {%- else -%}
              {{ (((ns.times[mid - 1] + ns.times[mid]) / 2) | as_datetime | as_local).isoformat() }}
            {%- endif -%}
          {%- else -%}
            'unavailable'
          {%- endif -%}
        availability: >
          {% set all_sensors = [
            'sensor.00000218736e3b1e_last_seen',
            'sensor.0000021dbca73412_last_seen',
            'sensor.0000039223703418_last_seen',
            'sensor.garbage_monitor_tag_last_seen',
            'sensor.0000021c3bc6341b_last_seen',
            'sensor.0000021d26a23414_last_seen',
            'sensor.00007e22b1d7b299_last_seen',
            'sensor.00007e225dc2b29f_last_seen',
            'sensor.00007e22b1b2b29a_last_seen'
          ] %}
          {% set ns = namespace(available = false) %}
          {% for sensor in all_sensors %}
            {% if states(sensor) not in ['unknown', 'unavailable', 'none', ''] %}
              {% set ns.available = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ ns.available }}
      - name: "Total Pending Epaperlink Transfers"
        unique_id: yaml_template_sensor_epaperlink_total_pending_transfers
        icon: mdi:transfer
        unit_of_measurement: transfers
        state: >
          {{ states.sensor
              | selectattr('entity_id', 'search', '_pending_transfer$')
              | map(attribute='state')
              | map('float', default=0)
              | sum }}

#################
#    SENSORS    #
#################
sensor:
  - platform: group
    name: "Epaperlink Pending Transfer Sensors"
    unique_id: yaml_group_sensor_epaperlink_pending_transfer_sensors
    type: sum
    ignore_non_numeric: true
    #unit_of_measurement: transfers
    entities: # Use template code:  - {{ states.sensor | selectattr('entity_id', 'search', '_pending_transfer$') | map(attribute='entity_id') | list | join('\n - ') }}
      - sensor.00007e1f7f9fb299_pending_transfer
      - sensor.00007e1f8b30b297_pending_transfer
      - sensor.780105561c92b300_pending_transfer
      - sensor.0000039223703418_pending_transfer
      - sensor.00007e225dceb293_pending_transfer
      - sensor.0000021c3bc6341b_pending_transfer
      - sensor.00007e225dd0b29c_pending_transfer
      - sensor.780105561a342201_pending_transfer
      - sensor.00007e22cc92b292_pending_transfer
      - sensor.780105561c817600_pending_transfer
      - sensor.780105561c294d00_pending_transfer
      - sensor.0000021e6b5b3b17_pending_transfer
      - sensor.00000218736e3b1e_pending_transfer
      - sensor.0000c87b913bdaec_pending_transfer
      - sensor.00007e1f8186b290_pending_transfer
      - sensor.garbage_monitor_tag_pending_transfer
      - sensor.0000021f86d83b1e_pending_transfer
      - sensor.780105561a2ce800_pending_transfer
      - sensor.00007e22b1d7b299_pending_transfer
      - sensor.00007e1f75f1b29b_pending_transfer
      - sensor.00007e225dc2b29f_pending_transfer
      - sensor.00007e22b1b2b29a_pending_transfer
      - sensor.000040866ce6fc84_pending_transfer
      - sensor.fd600b561a2ce800_pending_transfer
      - sensor.fd600bb900090900_pending_transfer
      - sensor.0000021dbca73412_pending_transfer
      - sensor.0000021d26a23414_pending_transfer
      - sensor.0000021d2ef23419_pending_transfer
      - sensor.fd600bd70007074d_pending_transfer
      - sensor.7801055600817600_pending_transfer
########################
#    BINARY SENSORS    #
########################
binary_sensor:

########################
#    INPUT BOOLEANS    #
########################
input_boolean:

##################
#    SWITCHES    #
##################
switch:

#####################
#    AUTOMATIONS    #
#####################
automation:
  - alias: '[misc|epaperlink]Timed update epaper displays'
    id: misc_epaperlink_timed_update_epaper_displays
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/30"
    action:
      - service: script.update_garbage_monitor_display

  - alias: '[misc|epaperlink]Update washing machine energy display'
    id: misc_epaperlink_update_washing_machine_energy_display
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/15"
      - platform: time
        at: '07:00:00'  # This will trigger the automation every morning at 7 AM
    condition:
      - condition: or  # Wrap the existing conditions in an or condition
        conditions:
          - condition: not
            conditions:
              - condition: template
                value_template: "{{ states('sensor.plug_washing_machine_power')|int < 5 }}"
                # for:
                #   minutes: 15
          - condition: template
            value_template: "{{ now().strftime('%H:%M:%S') == '07:00:00' }}"  # This effectively bypasses the conditions for the morning trigger
      - condition: time
        after: "6:00:00"
        before: "23:30:00"
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'),default=3000000000)) <= 240 }}" #Checks if tags have checked in in the past 4 minutes. Only updates if it actually works
    action:
      - service: script.update_washing_machine_energy_display

  - alias: '[misc|epaperlink]Update study displays'
    id: misc_epaperlink_update_study_displays
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/15"
    condition:
      - condition: state
        entity_id: binary_sensor.house_occupied
        state: 'on'
        for:
          minutes: 5
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.study_motion_combined
            state: 'off'
            for:
              minutes: 15
      - condition: time
        after: "6:00:00"
        before: "23:30:00"
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'),default=3000000000)) <= 240 }}" #Checks if tags have checked in in the past 4 minutes. Only updates if it actually works
    action:
      # - service: open_epaper_link.lines4
      #   target:
      #     entity_id: open_epaper_link.00000218736E3B1E
      #   data:
      #     line1: " Update: {{ states('sensor.time') | string }} "
      #     line2: " T: {{ states('sensor.study_aqm_temperature') | string }} C, CO2: {{ states('sensor.study_co2') | int | string }}"
      #     line3: "PM2.5: {{ states('sensor.study_pm_2_5_concentration') | int | string }} µg/m³ "
      #     line4: " Today's Elec {{ states('sensor.blitzwolf_computer_energy_today') | round(2) | string }} kWh "
      #     border: b
      #     format1: lwwb
      #     format2: lwwb
      #     format3: lwwb
      #     format4: lwwb
      - delay:
          seconds: 2
      - service: script.update_study_energy_display
      - delay:
          seconds: 2
      - service: script.update_study_climate_display

  - alias: '[misc|epaperlink]Timed update electricity price display'
    id: misc_epaperlink_timed_update_electricity_price_display
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "0"
    condition:
      - condition: time
        after: "6:00:00"
        before: "23:30:00"
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'),default=3000000000)) <= 240 }}" #Checks if tags have checked in in the past 4 minutes. Only updates if it actually works
    action:
      - choose:
        - conditions:
            - condition: time
              before: "15:00:00"
          sequence:
            #- service: script.update_energy_price_today_display
            - service: script.update_energy_price_today_larger_display
              data:
                display_entity_id:
                  # - open_epaper_link.00007E22B1D7B299 #Study
                  #- open_epaper_link.00007e22b1b2b29a #Washroom
                  - open_epaper_link.00007e225dc2b29f #Kitchen
                  - open_epaper_link.00007e22cc92b292 #New Display 1
                  - open_epaper_link.00007e1f8b30b297 #New Display 2
        default:
          #- service: script.update_energy_price_transition_display
          - service: script.update_energy_price_transition_larger_display
            data:
              display_entity_id:
                # - open_epaper_link.00007E22B1D7B299 #Study
                #- open_epaper_link.00007e22b1b2b29a #Washroom
                - open_epaper_link.00007e225dc2b29f #Kitchen
                - open_epaper_link.00007e22cc92b292 #New Display 1
                - open_epaper_link.00007e1f8b30b297 #New Display 2

  - alias: "[misc|epaperlink] Timed Update Moeke Water Tank Display"
    id: misc_epaperlink_timed_update_moeke_water_tank_display
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/30"  # Triggers every 30 minutes
      - platform: state
        entity_id:
          - binary_sensor.moeke_reservoir_leak_sensor
      - platform: state
        entity_id: sensor.moeke_low_water_warning
        to:
          - "No warning"
          - no_warning
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.moeke_low_water_warning
        not_to:
          - "No warning"
          - no_warning
        for:
          minutes: 5
    condition:
      - condition: time
        after: "06:00:00"
        before: "23:30:00"
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'),default=3000000000)) <= 240 }}" #Checks if tags have checked in in the past 4 minutes. Only updates if it actually works
    action:
      - service: script.update_moeke_water_tank_display
        data:
          display_entity_id: open_epaper_link.0000021DBCA73412

  - alias: "[misc|epaperlink] Update Pixel Litterbox Display"
    id: misc_epaperlink_update_pixel_litterbox_display
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/30"  # Triggers every 30 minutes
      - platform: state
        entity_id:
          - sensor.litterbox_counts_today
    condition:
      - condition: time
        after: "06:00:00"
        before: "23:30:00"
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'),default=3000000000)) <= 240 }}" #Checks if tags have checked in in the past 4 minutes. Only updates if it actually works
    action:
      - service: script.update_litterbox_display
        data:
          display_entity_id: open_epaper_link.0000021D26A23414

  - alias: "[misc|epaperlink] Tag Button Update of Displays"
    id: automation_yaml_misc_epaperlink_tag_button_update_of_displays
    mode: queued
    trigger:
      - platform: event
        event_type: open_epaper_link_event
        event_data:
          type: 'BUTTON1'
      - platform: event
        event_type: open_epaper_link_event
        event_data:
          type: 'BUTTON2'
    condition:
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.device_id == '00007E225DC2B29F' }}"
            sequence:
              - service: script.update_energy_price_today_larger_display
                data:
                  display_entity_id: open_epaper_link.00007e225dc2b29f
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.device_id == '00007E22B1D7B299' }}"
            sequence:
              - service: script.update_energy_price_today_larger_display
                data:
                  display_entity_id: open_epaper_link.00007E22B1D7B299
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.device_id == '00007E22B1B2B29A' }}"
            sequence:
              - service: script.update_energy_price_today_larger_display
                data:
                  display_entity_id: open_epaper_link.00007e22b1b2b29a

  - alias: "[misc|epaperlink]Notify if tag not seen"
    mode: restart
    trigger:
      - platform: time_pattern
        minutes: "/5"  # Check every 5 minutes
    condition:
      - condition: template
        value_template: >
          {%- set outdated = namespace(found=false) -%}
          {%- for sensor in [
              "sensor.00007e22b1d7b299_last_seen",
              "sensor.00007e22b1b2b29a_last_seen",
              "sensor.00007e225dc2b29f_last_seen",
              "sensor.00000218736e3b1e_last_seen",
              "sensor.0000021dbca73412_last_seen",
              "sensor.0000021d26a23414_last_seen",
              "sensor.0000039223703418_last_seen",
              "sensor.garbage_monitor_tag_last_seen"
            ] -%}
              {%- set last_seen = states(sensor) -%}
              {%- if last_seen == 'unavailable' or (last_seen == 'unknown') or (last_seen == '') or (as_timestamp(now()) - as_timestamp(last_seen | default(0)) > 300) -%}
                {%- set outdated.found = true -%}
              {%- endif -%}
          {% endfor %}
          {{ outdated.found }}
    action:
      # - condition: template
      #   value_template: "{{ trigger.to_state.state == 'unavailable' or (as_timestamp(now()) - as_timestamp(trigger.to_state.last_changed)) > 300 }}"
      - service: persistent_notification.create
        data_template:
          title: "Tag Not Seen Alert"
          notification_id: tag_not_seen_alert
          message: >
            One or more tags have not been seen for more than 5 minutes:
            {% for sensor in [
                "sensor.00007e22b1d7b299_last_seen",
                "sensor.00007e22b1b2b29a_last_seen",
                "sensor.00007e225dc2b29f_last_seen",
                "sensor.00000218736e3b1e_last_seen",
                "sensor.0000021dbca73412_last_seen",
                "sensor.0000021d26a23414_last_seen",
                "sensor.0000039223703418_last_seen",
                "sensor.garbage_monitor_tag_last_seen"
              ] %}
                {%- set last_seen = states(sensor) -%}
                {%- if last_seen == 'unavailable' or last_seen == 'unknown' or last_seen == '' or (as_timestamp(now()) - as_timestamp(last_seen | default(0)) > 300) -%}
                  {%- if not state_attr(sensor, 'friendly_name') == None -%}
                    {{ state_attr(sensor, 'friendly_name') | replace(' Last Seen', '') }}{% if not loop.last %}, {% endif %}
                  {%- else -%}
                    {{ state_attr(sensor, 'entity_id') }}{% if not loop.last %}, {% endif %}
                  {%- endif -%}
                {%- endif -%}
            {%- endfor -%}
      - wait_for_trigger:
          - platform: template
            value_template: >
              {% set recent_seen = true %}
              {% for sensor in [
                  "sensor.00007e22b1d7b299_last_seen",
                  "sensor.00007e22b1b2b29a_last_seen",
                  "sensor.00007e225dc2b29f_last_seen",
                  "sensor.00000218736e3b1e_last_seen",
                  "sensor.0000021dbca73412_last_seen",
                  "sensor.0000021d26a23414_last_seen",
                  "sensor.0000039223703418_last_seen",
                  "sensor.garbage_monitor_tag_last_seen"
                ] %}
                  {%- set last_seen = states(sensor) -%}
                  {%- if last_seen == 'unavailable' or last_seen == 'unknown' or last_seen == '' or (as_timestamp(now()) - as_timestamp(last_seen | default(0)) > 300) -%}
                    {% set recent_seen = false %}
                  {%- endif -%}
              {% endfor %}
              {{ recent_seen }}
            for:
              minutes: 1  # Wait to ensure all sensors have recently been seen for at least 1 minute
      - service: persistent_notification.dismiss
        data:
          notification_id: tag_not_seen_alert

  - alias: "[misc|epaperlink]Trigger Reload When Last Seen Exceeds 5 Minutes"
    description: "Reloads config entry if the median last check-in time is more than 5 minutes. In this case, it is likely that the integration has failed and needs a restart."
    mode: restart
    id: yaml_automation_misc_epaperlink_trigger_reload_when_last_seen_exceeds_5_minutes
    trigger:
      - platform: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'), default=3000000000)) > 300 }} #default of 3000000000 is Saturday, January 24, 2065 6:20:00 AM
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.epaperlink_study_ap_round_trip_time_average
            state: 'unavailable'
      - condition: template
        value_template: >
          {{ state_attr('automation.misc_epaperlink_power_cycle_ap_when_ap_is_unavailable_and_devices_haven_t_checked_in', 'current') == 0 }}
    action:
      # Attempt to reload the integration until devices have checked in or max attempts reached
      - alias: "Reload Integration Until Devices Check In or Max Attempts"
        repeat:
          sequence:
            # Reload the OpenEPaperLink integration
            - service: homeassistant.reload_config_entry
              data:
                entry_id: dcd0a828896007b5be2b87a699bb028f
            # Wait for devices to check in
            - wait_template: >
                {{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'), default=3000000000)) < 300 }}
              timeout: '00:01:00'  # Wait up to 1 minute
              continue_on_timeout: true
          until:
            # Exit loop if devices have checked in or maximum attempts reached
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'), default=3000000000)) < 300 }}
                - condition: template
                  value_template: >
                    {{ repeat.index >= 3 }}
      # Check if devices have checked in
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'), default=3000000000)) < 300 }}
            sequence:
              # Devices have checked in, trigger display updates
              - service: automation.trigger
                entity_id:
                  - automation.misc_epaperlink_timed_update_electricity_price_display
                  - automation.misc_epaperlink_timed_update_moeke_water_tank_display
                  - automation.misc_epaperlink_update_pixel_litterbox_display
                  - automation.misc_epaperlink_update_study_displays
        default:
          # Devices haven't checked in, send a notification
          - service: notify.mobile_app_your_android_phone
            data:
              title: "OpenEPaperLink Integration Issue"
              message: "Devices haven't checked in after multiple integration reloads."

  - alias: "[misc|epaperlink] Power Cycle AP When AP is Unavailable and Devices Haven't Checked In"
    description: "Power cycles the AP and reloads the integration when the AP is unavailable and devices haven't checked in."
    id: yaml_automation_misc_epaperlink_power_cycle_ap_when_ap_is_unavailable_and_devices_havent_checked_in
    mode: single
    trigger:
      # Trigger when the ping sensor becomes 'unavailable' for more than 1 minute
      - platform: state
        entity_id: sensor.epaperlink_study_ap_round_trip_time_average
        to: 'unavailable'
        for:
          minutes: 2
    condition:
      # Condition: Median check-in time is 'unavailable' or exceeds 10 minutes
      - condition: template
        value_template: >
          {{
            states('sensor.median_epaper_tag_last_check_in_time') == 'unavailable' or
            (as_timestamp(now()) - as_timestamp(states('sensor.median_epaper_tag_last_check_in_time'))) > 600
          }}
    action:
      # Repeat power cycling the AP until it becomes available or maximum attempts reached
      - alias: "Power Cycle AP Until Available or Max Attempts"
        repeat:
          sequence:
            # Power off the AP
            - service: switch.turn_off
              entity_id: switch.plug_epaper_ap_switch
            # Wait for 5 seconds
            - delay:
                seconds: 5
            # Power on the AP
            - service: switch.turn_on
              entity_id: switch.plug_epaper_ap_switch
            # Wait for the AP to boot up
            - delay:
                seconds: 60
          until:
            # Exit loop if AP is pingable or maximum attempts reached
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ not is_state('sensor.epaperlink_study_ap_round_trip_time_average', 'unavailable') }}
                - condition: template
                  value_template: >
                    {{ repeat.index >= 3 }}
      - delay:
          minutes: 5
      # Check if the AP is now available
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ is_state('sensor.median_epaper_tag_last_check_in_time', 'unavailable') }}
            sequence:
              # Reload the OpenEPaperLink integration
              - service: homeassistant.reload_config_entry
                data:
                  entry_id: dcd0a828896007b5be2b87a699bb028f
              # Wait for 1 minute to allow devices to check in
              - delay:
                  minutes: 1
              # Trigger the display update automations
      - service: automation.trigger
        entity_id:
          - automation.misc_epaperlink_timed_update_electricity_price_display
          - automation.misc_epaperlink_timed_update_moeke_water_tank_display
          - automation.misc_epaperlink_update_pixel_litterbox_display
          - automation.misc_epaperlink_update_study_displays
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ is_state('sensor.median_epaper_tag_last_check_in_time', 'unavailable') }}
            sequence:
              # If AP is still unavailable, send a notification
              - service: notify.mobile_app_blokmeisters21u
                data:
                  title: "OpenEPaperLink AP Issue"
                  message: "AP did not come back online after multiple power cycles."


################
#    SCENES    #
################
scene:

################
#    GROUPS    #
################
group:

#################
#    SCRIPTS    #
#################
script:
  update_washing_machine_energy_display:
    alias: "Update Washing Machine Energy Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.0000021C3BC6341B
        data:
          background: white
          rotate: 0
          payload:
            - type: text
              value: "Energy today:"
              font: ppb.ttf
              x: 10
              "y": 10
              size: 18
              color: 'black'
            - type: text
              value: "{{ states('sensor.plug_washing_machine_energy_today') | string }}"
              font: ppb.ttf
              x: 10
              "y": 38
              size: 45
              color: 'red'
            - type: text
              value: "kWh"
              font: ppb.ttf
              x: 50
              "y": 85
              size: 18
              color: black
            - type: text
              value: "Energy yesterday:"
              font: ppb.ttf
              x: 10
              "y": 102
              size: 14
              color: black
            - type: text
              value: "{{ states('sensor.blitzwolf_washingmachine_energy_yesterday') | string }}"
              font: ppb.ttf
              x: 10
              "y": 118
              size: 18
              color: red
            - type: text
              value: "kWh"
              font: ppb.ttf
              x: 50
              "y": 138
              size: 15
              color: black

  update_energy_price_today_display:
    alias: "Update Energy Price Today Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.0000021f86d83b1e
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 0 else 'black' }}"
              width: 1
              x_start: 30
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[0].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 38
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[0].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 1 else 'black' }}"
              width: 1
              x_start: 41
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[1].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 49
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[1].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 2 else 'black' }}"
              width: 1
              x_start: 51
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[2].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 59
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[2].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 3 else 'black' }}"
              width: 1
              x_start: 62
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[3].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 70
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[3].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 4 else 'black' }}"
              width: 1
              x_start: 72
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[4].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 80
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[4].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 5 else 'black' }}"
              width: 1
              x_start: 83
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[5].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 91
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[5].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 6 else 'black' }}"
              width: 1
              x_start: 94
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[6].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 102
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[6].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 7 else 'black' }}"
              width: 1
              x_start: 104
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[7].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 112
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[7].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 8 else 'black' }}"
              width: 1
              x_start: 115
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[8].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 123
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[8].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 9 else 'black' }}"
              width: 1
              x_start: 125
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[9].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 133
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[9].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 10 else 'black' }}"
              width: 1
              x_start: 136
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[10].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 144
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[10].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 11 else 'black' }}"
              width: 1
              x_start: 146
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[11].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 154
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[11].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 12 else 'black' }}"
              width: 1
              x_start: 157
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 165
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 13 else 'black' }}"
              width: 1
              x_start: 168
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 176
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 14 else 'black' }}"
              width: 1
              x_start: 178
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 186
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 15 else 'black' }}"
              width: 1
              x_start: 189
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 197
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 16 else 'black' }}"
              width: 1
              x_start: 199
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 207
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 17 else 'black' }}"
              width: 1
              x_start: 210
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 218
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 18 else 'black' }}"
              width: 1
              x_start: 220
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 228
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 19 else 'black' }}"
              width: 1
              x_start: 231
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 239
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 20 else 'black' }}"
              width: 1
              x_start: 242
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 250
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 21 else 'black' }}"
              width: 1
              x_start: 252
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 260
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 22 else 'black' }}"
              width: 1
              x_start: 263
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 271
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 23 else 'black' }}"
              width: 1
              x_start: 273
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 281
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"

            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 10
              x_end: 286
              y_end: 10
            - type: text
              value: '€0.50'
              x: 0
              "y": 1
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 30
              x_end: 286
              y_end: 30
            - type: text
              value: '€0.40'
              x: 0
              "y": 21
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 49
              x_end: 286
              y_end: 49
            - type: text
              value: '€0.30'
              x: 0
              "y": 40
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 69
              x_end: 286
              y_end: 69
            - type: text
              value: '€0.20'
              x: 0
              "y": 60
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 88
              x_end: 286
              y_end: 88
            - type: text
              value: '€0.10'
              x: 0
              "y": 79
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 108
              x_end: 286
              y_end: 108
            - type: text
              value: '€0.00'
              x: 0
              "y": 99
              size: 8
              color: black
              font: "ppb.ttf"

            - type: text
              value: "0:00"
              x: 20  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "6:00"
              x: 84  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "12:00"
              x: 147  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "18:00"
              x: 210  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "24:00"
              x: 260  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"

            # - type: text
            #   value: "High: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'max')|float()) }}"
            #   x: 285
            #   "y": 2
            #   size: 13
            #   color: white
            #   font: "/config/www/fonts/poppins/Poppins-Black.ttf" #"ppb.ttf"
            #   anchor: rt
            # - type: text
            #   value: "Low: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'min')|float()) }}"
            #   x: 285
            #   "y": 15
            #   size: 13
            #   color: white
            #   font: "/config/www/fonts/poppins/Poppins-Black.ttf" #"ppb.ttf"
            #   anchor: rt
            # - type: text
            #   value: "Current: €{{ '{:0.3f}'.format(states('sensor.nordpool_energy_price')|float()) }}"
            #   x: 285
            #   "y": 28
            #   size: 13
            #   color: white
            #   font: "/config/www/fonts/poppins/Poppins-Black.ttf" #"ppb.ttf"
            #   anchor: rt

            - type: text
              value: "High: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'max')|float()) }}"
              x: 285
              "y": 2
              size: 10
              color: red
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf" #"ppb.ttf"
              anchor: rt
            - type: text
              value: "Low: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'min')|float()) }}"
              x: 285
              "y": 15
              size: 10
              color: red
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf" #"ppb.ttf"
              anchor: rt
            - type: text
              value: "Current: €{{ '{:0.3f}'.format(states('sensor.nordpool_energy_price')|float()) }}"
              x: 285
              "y": 28
              size: 10
              color: red
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf" #"ppb.ttf"
              anchor: rt

            - type: text
              value: "High: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'max')|float()) }}"
              x: 185
              "y": 2
              size: 10
              color: red
              font: "/config/www/fonts/PixeloidMono_9px_h10.ttf" #"ppb.ttf"
              anchor: rt
            - type: text
              value: "Low: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'min')|float()) }}"
              x: 185
              "y": 15
              size: 10
              color: red
              font: "/config/www/fonts/PixeloidMono_9px_h10.ttf" #"ppb.ttf"
              anchor: rt
            - type: text
              value: "Current: €{{ '{:0.3f}'.format(states('sensor.nordpool_energy_price')|float()) }}"
              x: 185
              "y": 28
              size: 10
              color: red
              font: "/config/www/fonts/PixeloidMono_9px_h10.ttf" #"ppb.ttf"
              anchor: rt

  update_energy_price_tomorrow_display:
    alias: "Update Energy Price Tomorrow Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.0000021f86d83b1e
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 0 else 'black' }}"
              width: 1
              x_start: 30
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[0].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 38
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 1 else 'black' }}"
              width: 1
              x_start: 41
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[1].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 49
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 2 else 'black' }}"
              width: 1
              x_start: 51
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[2].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 59
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 3 else 'black' }}"
              width: 1
              x_start: 62
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[3].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 70
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 4 else 'black' }}"
              width: 1
              x_start: 72
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[4].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 80
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 5 else 'black' }}"
              width: 1
              x_start: 83
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[5].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 91
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 6 else 'black' }}"
              width: 1
              x_start: 94
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[6].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 102
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 7 else 'black' }}"
              width: 1
              x_start: 104
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[7].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 112
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 8 else 'black' }}"
              width: 1
              x_start: 115
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[8].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 123
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 9 else 'black' }}"
              width: 1
              x_start: 125
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[9].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 133
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 10 else 'black' }}"
              width: 1
              x_start: 136
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[10].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 144
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 11 else 'black' }}"
              width: 1
              x_start: 146
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[11].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 154
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 12 else 'black' }}"
              width: 1
              x_start: 157
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[12].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 165
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 13 else 'black' }}"
              width: 1
              x_start: 168
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[13].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 176
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 14 else 'black' }}"
              width: 1
              x_start: 178
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[14].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 186
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 15 else 'black' }}"
              width: 1
              x_start: 189
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[15].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 197
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 16 else 'black' }}"
              width: 1
              x_start: 199
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[16].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 207
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 17 else 'black' }}"
              width: 1
              x_start: 210
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[17].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 218
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 18 else 'black' }}"
              width: 1
              x_start: 220
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[18].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 228
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 19 else 'black' }}"
              width: 1
              x_start: 231
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[19].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 239
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 20 else 'black' }}"
              width: 1
              x_start: 242
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[20].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 250
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 21 else 'black' }}"
              width: 1
              x_start: 252
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[21].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 260
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 22 else 'black' }}"
              width: 1
              x_start: 263
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[22].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 271
              y_end: 108
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 23 else 'black' }}"
              width: 1
              x_start: 273
              y_start: "{{ 108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[23].value / 0.50 * (108 - 10))) | round(0) }}"
              x_end: 281
              y_end: 108

            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 10
              x_end: 286
              y_end: 10
            - type: text
              value: '€0.50'
              x: 0
              "y": 1
              size: 8
              color: black
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 30
              x_end: 286
              y_end: 30
            - type: text
              value: '€0.40'
              x: 0
              "y": 21
              size: 8
              color: black
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 49
              x_end: 286
              y_end: 49
            - type: text
              value: '€0.30'
              x: 0
              "y": 40
              size: 8
              color: black
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 69
              x_end: 286
              y_end: 69
            - type: text
              value: '€0.20'
              x: 0
              "y": 60
              size: 8
              color: black
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 88
              x_end: 286
              y_end: 88
            - type: text
              value: '€0.10'
              x: 0
              "y": 79
              size: 8
              color: black
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 108
              x_end: 286
              y_end: 108

            - type: text
              value: '€0.00'
              x: 0
              "y": 99
              size: 8
              color: black
            - type: text
              value: "0:00"
              x: 20  # Adjust for alignment
              "y": 113
              size: 8
              color: black
            - type: text
              value: "6:00"
              x: 84  # Adjust for alignment
              "y": 113
              size: 8
              color: black
            - type: text
              value: "12:00"
              x: 147  # Adjust for alignment
              "y": 113
              size: 8
              color: black
            - type: text
              value: "18:00"
              x: 210  # Adjust for alignment
              "y": 113
              size: 8
              color: black
            - type: text
              value: "24:00"
              x: 260  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"

            # - type: rectangle
            #   outline: white
            #   fill: white
            #   x_start: 226
            #   y_start: 10
            #   x_end: 286
            #   y_end: 30

            - type: text
              value: "Current: €{{ states.sensor.nordpool_energy_price.attributes.raw_today[now().hour].value }}"
              x: 285
              "y": 12
              size: 12
              color: red
              anchor: rt

            # - type: text
            #   value: "{{ now().hour }}:00"
            #   x: "{{ (10 + (now().hour * (single_bar_width + space_between_bars))) }}"
            #   "y": 50  # Adjust the position as needed
            #   size: 8
            #   color: red

  update_energy_price_transition_display:
    alias: "Update Energy Price Transition Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.0000021f86d83b1e
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 12 else 'black' }}"
              width: 1
              x_start: 30
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 38
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 13 else 'black' }}"
              width: 1
              x_start: 41
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 49
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 14 else 'black' }}"
              width: 1
              x_start: 51
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 59
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 15 else 'black' }}"
              width: 1
              x_start: 62
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 70
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 16 else 'black' }}"
              width: 1
              x_start: 72
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 80
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 17 else 'black' }}"
              width: 1
              x_start: 83
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 91
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 18 else 'black' }}"
              width: 1
              x_start: 94
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 102
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 19 else 'black' }}"
              width: 1
              x_start: 104
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 112
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 20 else 'black' }}"
              width: 1
              x_start: 115
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 123
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 21 else 'black' }}"
              width: 1
              x_start: 125
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 133
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 22 else 'black' }}"
              width: 1
              x_start: 136
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 144
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 23 else 'black' }}"
              width: 1
              x_start: 146
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 154
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 0 else 'black' }}"
              width: 1
              x_start: 157
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[0].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 165
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[0].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 1 else 'black' }}"
              width: 1
              x_start: 168
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[1].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 176
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[1].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 2 else 'black' }}"
              width: 1
              x_start: 178
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[2].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 186
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[2].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 3 else 'black' }}"
              width: 1
              x_start: 189
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[3].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 197
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[3].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 4 else 'black' }}"
              width: 1
              x_start: 199
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[4].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 207
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[4].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 5 else 'black' }}"
              width: 1
              x_start: 210
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[5].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 218
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[5].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 6 else 'black' }}"
              width: 1
              x_start: 220
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[6].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 228
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[6].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 7 else 'black' }}"
              width: 1
              x_start: 231
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[7].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 239
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[7].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 8 else 'black' }}"
              width: 1
              x_start: 242
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[8].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 250
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[8].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 9 else 'black' }}"
              width: 1
              x_start: 252
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[9].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 260
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[9].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 10 else 'black' }}"
              width: 1
              x_start: 263
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[10].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 271
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[10].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 11 else 'black' }}"
              width: 1
              x_start: 273
              y_start: "{{ max(min(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[11].value / 0.50 * (108 - 10))) | round(0), 108), 10) }}"
              x_end: 281
              y_end: "{{ min(max(108 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[11].value / 0.50 * (108 - 10))) | round(0), 108), 128) }}"

            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 10
              x_end: 286
              y_end: 10
            - type: text
              value: '€0.50'
              x: 0
              "y": 1
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 30
              x_end: 286
              y_end: 30
            - type: text
              value: '€0.40'
              x: 0
              "y": 21
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 49
              x_end: 286
              y_end: 49
            - type: text
              value: '€0.30'
              x: 0
              "y": 40
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 69
              x_end: 286
              y_end: 69
            - type: text
              value: '€0.20'
              x: 0
              "y": 60
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 88
              x_end: 286
              y_end: 88
            - type: text
              value: '€0.10'
              x: 0
              "y": 79
              size: 8
              color: black
              font: "ppb.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 25
              y_start: 108
              x_end: 286
              y_end: 108
            - type: text
              value: '€0.00'
              x: 0
              "y": 99
              size: 8
              color: black
              font: "ppb.ttf"

            - type: text
              value: "12:00"
              x: 20  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "18:00"
              x: 84  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "0:00"
              x: 147  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "6:00"
              x: 210  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"
            - type: text
              value: "12:00"
              x: 260  # Adjust for alignment
              "y": 113
              size: 9
              color: black
              font: "ppb.ttf"

            - type: text
              value: "High: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'max')|float()) }}"
              x: 285
              "y": 2
              size: 13
              color: red
              font: "ppb.ttf"
              anchor: rt
            - type: text
              value: "Low: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'min')|float()) }}"
              x: 285
              "y": 15
              size: 13
              color: red
              font: "ppb.ttf"
              anchor: rt
            - type: text
              value: "Current: €{{ '{:0.3f}'.format(states('sensor.nordpool_energy_price')|float()) }}"
              x: 285
              "y": 28
              size: 13
              color: red
              font: "ppb.ttf"
              anchor: rt

            - type: line
              fill: red
              width: 1
              x_start: 155
              y_start: 10
              x_end: 155
              y_end: 108

  update_energy_price_today_larger_display:
    alias: "Update Energy Price Today Larger Display"
    description: "Updates the new Solum M3 2.9 inch screens with today's electricty prices"
    mode: queued
    fields:
      display_entity_id:
        description: "The entity ID of the display to be updated"
        example: "open_epaper_link.00007E22B1D7B299"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: "{{ display_entity_id }}"
            # - open_epaper_link.00007E22B1D7B299
            # #- open_epaper_link.00007e22b1b2b29a
            # - open_epaper_link.00007e225dc2b29f
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 0 else 'black' }}"
              width: 1
              x_start: 35
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[0].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 46
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[0].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 1 else 'black' }}"
              width: 1
              x_start: 49
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[1].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 60
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[1].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 2 else 'black' }}"
              width: 1
              x_start: 63
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[2].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 74
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[2].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 3 else 'black' }}"
              width: 1
              x_start: 77
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[3].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 88
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[3].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 4 else 'black' }}"
              width: 1
              x_start: 91
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[4].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 102
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[4].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 5 else 'black' }}"
              width: 1
              x_start: 105
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[5].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 116
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[5].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 6 else 'black' }}"
              width: 1
              x_start: 119
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[6].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 130
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[6].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 7 else 'black' }}"
              width: 1
              x_start: 133
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[7].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 144
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[7].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 8 else 'black' }}"
              width: 1
              x_start: 147
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[8].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 158
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[8].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 9 else 'black' }}"
              width: 1
              x_start: 161
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[9].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 172
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[9].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 10 else 'black' }}"
              width: 1
              x_start: 175
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[10].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 186
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[10].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 11 else 'black' }}"
              width: 1
              x_start: 189
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[11].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 200
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[11].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 12 else 'black' }}"
              width: 1
              x_start: 204
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 215
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 13 else 'black' }}"
              width: 1
              x_start: 218
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 229
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 14 else 'black' }}"
              width: 1
              x_start: 232
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 243
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 15 else 'black' }}"
              width: 1
              x_start: 246
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 257
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 16 else 'black' }}"
              width: 1
              x_start: 260
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 271
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 17 else 'black' }}"
              width: 1
              x_start: 274
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 285
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 18 else 'black' }}"
              width: 1
              x_start: 288
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 299
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 19 else 'black' }}"
              width: 1
              x_start: 302
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 313
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 20 else 'black' }}"
              width: 1
              x_start: 316
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 327
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 21 else 'black' }}"
              width: 1
              x_start: 330
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 341
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 22 else 'black' }}"
              width: 1
              x_start: 344
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 355
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 23 else 'black' }}"
              width: 1
              x_start: 358
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 369
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"

            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 10
              x_end: 374
              y_end: 10
            - type: text
              value: '€0.50'
              x: 1
              "y": 1
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 38
              x_end: 374
              y_end: 38
            - type: text
              value: '€0.40'
              x: 1
              "y": 29
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 65
              x_end: 374
              y_end: 65
            - type: text
              value: '€0.30'
              x: 1
              "y": 56
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 93
              x_end: 374
              y_end: 93
            - type: text
              value: '€0.20'
              x: 1
              "y": 84
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 120
              x_end: 374
              y_end: 120
            - type: text
              value: '€0.10'
              x: 1
              "y": 111
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 148
              x_end: 374
              y_end: 148
            - type: text
              value: '€0.00'
              x: 1
              "y": 139
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"

            - type: text
              value: "0:00"
              x: 27  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "6:00"
              x: 109  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "12:00"
              x: 190  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "18:00"
              x: 272  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "24:00"
              x: 354  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"

            - type: text
              value: "Max: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'max')|float()) }}"
              x: 373
              "y": 3
              size: 16
              color: red
              font: "/config/www/fonts/SF Pixelate 10pt/SF Pixelate Bold.ttf"
              stroke_width: 2
              stroke_fill: 'white'
              anchor: rt
            - type: text
              value: "Min: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'min')|float()) }}"
              x: 373
              "y": 19
              size: 16
              color: red
              font: "/config/www/fonts/SF Pixelate 10pt/SF Pixelate Bold.ttf"
              stroke_width: 2
              stroke_fill: 'white'
              anchor: rt
            - type: text
              value: "Current: €{{ '{:0.3f}'.format(states('sensor.nordpool_energy_price')|float()) }}"
              x: 373
              "y": 35
              size: 16
              color: red
              font: "/config/www/fonts/SF Pixelate 10pt/SF Pixelate Bold.ttf"
              stroke_width: 2
              stroke_fill: 'white'
              anchor: rt

  update_energy_price_transition_larger_display:
    alias: "Update Energy Price Transition Larger Display"
    description: "Updates the new Solum M3 2.9 inch screens with tonight's and tomorrow morning's electricty prices"
    mode: queued
    fields:
      display_entity_id:
        description: "The entity ID of the display to be updated"
        example: "open_epaper_link.00007E22B1D7B299"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: "{{ display_entity_id }}"
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 12 else 'black' }}"
              width: 1
              x_start: 35
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 46
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[12].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 13 else 'black' }}"
              width: 1
              x_start: 49
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 60
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[13].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 14 else 'black' }}"
              width: 1
              x_start: 63
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 74
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[14].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 15 else 'black' }}"
              width: 1
              x_start: 77
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 88
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[15].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 16 else 'black' }}"
              width: 1
              x_start: 91
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 102
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[16].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 17 else 'black' }}"
              width: 1
              x_start: 105
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 116
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[17].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 18 else 'black' }}"
              width: 1
              x_start: 119
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 130
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[18].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 19 else 'black' }}"
              width: 1
              x_start: 133
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 144
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[19].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 20 else 'black' }}"
              width: 1
              x_start: 147
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 158
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[20].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 21 else 'black' }}"
              width: 1
              x_start: 161
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 172
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[21].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 22 else 'black' }}"
              width: 1
              x_start: 175
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 186
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[22].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 23 else 'black' }}"
              width: 1
              x_start: 189
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 200
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_today[23].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 0 else 'black' }}"
              width: 1
              x_start: 204
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[0].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 215
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[0].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 1 else 'black' }}"
              width: 1
              x_start: 218
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[1].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 229
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[1].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 2 else 'black' }}"
              width: 1
              x_start: 232
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[2].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 243
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[2].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 3 else 'black' }}"
              width: 1
              x_start: 246
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[3].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 257
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[3].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 4 else 'black' }}"
              width: 1
              x_start: 260
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[4].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 271
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[4].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 5 else 'black' }}"
              width: 1
              x_start: 274
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[5].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 285
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[5].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 6 else 'black' }}"
              width: 1
              x_start: 288
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[6].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 299
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[6].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 7 else 'black' }}"
              width: 1
              x_start: 302
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[7].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 313
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[7].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 8 else 'black' }}"
              width: 1
              x_start: 316
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[8].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 327
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[8].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 9 else 'black' }}"
              width: 1
              x_start: 330
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[9].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 341
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[9].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 10 else 'black' }}"
              width: 1
              x_start: 344
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[10].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 355
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[10].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"
            - type: rectangle
              outline: black
              fill: "{{ 'red' if now().hour == 11 else 'black' }}"
              width: 1
              x_start: 358
              y_start: "{{ max(min(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[11].value / 0.50 * (148 - 5))) | round(0), 148), 5) }}"
              x_end: 369
              y_end: "{{ min(max(148 - ((states.sensor.nordpool_energy_price.attributes.raw_tomorrow[11].value / 0.50 * (148 - 5))) | round(0), 148), 168) }}"

            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 10
              x_end: 374
              y_end: 10
            - type: text
              value: '€0.50'
              x: 1
              "y": 1
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 38
              x_end: 374
              y_end: 38
            - type: text
              value: '€0.40'
              x: 1
              "y": 29
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 65
              x_end: 374
              y_end: 65
            - type: text
              value: '€0.30'
              x: 1
              "y": 56
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 93
              x_end: 374
              y_end: 93
            - type: text
              value: '€0.20'
              x: 1
              "y": 84
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 120
              x_end: 374
              y_end: 120
            - type: text
              value: '€0.10'
              x: 1
              "y": 111
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: line
              fill: black
              width: 1
              x_start: 30
              y_start: 148
              x_end: 374
              y_end: 148
            - type: text
              value: '€0.00'
              x: 1
              "y": 139
              size: 10
              color: black
              anchor: lt
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"

            - type: text
              value: "12:00"
              x: 27  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "18:00"
              x: 109  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "0:00"
              x: 190  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "6:00"
              x: 272  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"
            - type: text
              value: "12:00"
              x: 354  # Adjust for alignment
              "y": 162
              size: 10
              color: black
              anchor: lb
              font: "/config/www/fonts/Pixolletta_8px_h14.ttf"

            - type: text
              value: "Max: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'max')|float()) }}"
              x: 373
              "y": 3
              size: 16
              color: red
              font: "/config/www/fonts/SF Pixelate 10pt/SF Pixelate Bold.ttf"
              stroke_width: 2
              stroke_fill: 'white'
              anchor: rt
            - type: text
              value: "Min: €{{ '{:0.3f}'.format(state_attr('sensor.nordpool_energy_price', 'min')|float()) }}"
              x: 373
              "y": 19
              size: 16
              color: red
              font: "/config/www/fonts/SF Pixelate 10pt/SF Pixelate Bold.ttf"
              stroke_width: 2
              stroke_fill: 'white'
              anchor: rt
            - type: text
              value: "Current: €{{ '{:0.3f}'.format(states('sensor.nordpool_energy_price')|float()) }}"
              x: 373
              "y": 35
              size: 16
              color: red
              font: "/config/www/fonts/SF Pixelate 10pt/SF Pixelate Bold.ttf"
              stroke_width: 2
              stroke_fill: 'white'
              anchor: rt

  update_garbage_monitor_display:
    alias: "Update Garbage Monitor Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.00000219A2923B10
        data:
          background: white
          rotate: 0
          payload:
            - type: line
              fill: red
              width: 3
              x_start: 5
              y_start: 64
              x_end: 121
              y_end: 64
            - type: line
              fill: red
              width: 3
              x_start: 168
              y_start: 64
              x_end: 290
              y_end: 64
            - type: line
              fill: red
              width: 3
              x_start: 148
              y_start: 5
              x_end: 148
              y_end: 34
            - type: line
              fill: red
              width: 3
              x_start: 148
              y_start: 89
              x_end: 148
              y_end: 123

            - type: rectangle
              outline: white
              fill: >-
                {{'white' if states('sensor.days_to_restafval') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_restafval') | int > 1 else 'red' }}
              width: 1
              x_start: 5
              y_start: 5
              x_end: 123
              y_end: 60
            - type: text
              value: Restafval
              font: ppb.ttf
              x: 35
              "y": 10
              size: 18
              color: >-
                {{'black' if states('sensor.days_to_restafval') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_restafval') | int > 1 else 'white' }}
            - type: text
              value: >-
                {% if states('sensor.days_to_restafval') in ['unknown', 'unavailable', 'none'] %}
                  Unknown
                {% elif states('sensor.days_to_restafval') | int == 0 %}
                  Today
                {% elif states('sensor.days_to_restafval') | int == 1 %}
                  Tonight
                {% else %}
                  {{states('sensor.days_to_restafval')}} days
                {% endif %}
              font: ppb.ttf
              x: 35
              "y": 33
              size: 18
              color: >-
                {{'black' if states('sensor.days_to_restafval') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_restafval') | int > 1 else 'white' }}

            - type: rectangle
              outline: white
              fill: >-
                {{'white' if states('sensor.days_to_papier') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_papier') | int > 1 else 'red' }}
              width: 1
              x_start: 168
              y_start: 5
              x_end: 290
              y_end: 60
            - type: text
              value: Papier
              font: ppb.ttf
              x: 190
              "y": 10
              size: 18
              color: >-
                {{'black' if states('sensor.days_to_papier') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_papier') | int > 1 else 'white' }}
            - type: text
              value: >-
                {% if states('sensor.days_to_papier') in ['unknown', 'unavailable', 'none'] %}
                  Unknown
                {% elif states('sensor.days_to_papier') | int == 0 %}
                  Today
                {% elif states('sensor.days_to_papier') | int == 1 %}
                  Tonight
                {% else %}
                  {{states('sensor.days_to_papier')}} days
                {% endif %}
              font: ppb.ttf
              x: 190
              "y": 33
              size: 18
              color: >-
                {{'black' if states('sensor.days_to_papier') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_papier') | int > 1 else 'white' }}

            - type: rectangle
              outline: white
              fill: >-
                {{'white' if states('sensor.days_to_gft') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_gft') | int > 1 else 'red' }}
              width: 1
              x_start: 5
              y_start: 70
              x_end: 123
              y_end: 123
            - type: text
              value: GFT
              font: ppb.ttf
              x: 35
              "y": 80
              size: 18
              color: >-
                {{'black' if states('sensor.days_to_gft') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_gft') | int > 1 else 'white' }}
            - type: text
              value: >-
                {% if states('sensor.days_to_gft') in ['unknown', 'unavailable', 'none'] %}
                  Unknown
                {% elif states('sensor.days_to_gft') | int == 0 %}
                  Today
                {% elif states('sensor.days_to_gft') | int == 1 %}
                  Tonight
                {% else %}
                  {{states('sensor.days_to_gft')}} days
                {% endif %}
              font: ppb.ttf
              x: 35
              "y": 103
              size: 18
              color: >-
                {{'black' if states('sensor.days_to_gft') in ['unknown', 'unavailable', 'none'] or
                states('sensor.days_to_gft') | int > 1 else 'white' }}

            - type: rectangle
              outline: white
              fill: white
              width: 1
              x_start: 0
              y_start: 119
              x_end: 100
              y_end: 128
            - type: text
              value: " {{ states('sensor.date') | string }} "
              font: ppb.ttf
              x: 0
              "y": 119
              size: 9
              color: black
            - type: icon
              value: >-
                {{ 'alert-circle' if
                  (states('sensor.days_to_restafval') in ['unknown', 'unavailable', 'none']) or
                  (states('sensor.days_to_papier') in ['unknown', 'unavailable', 'none']) or
                  (states('sensor.days_to_gft') in ['unknown', 'unavailable', 'none'])
                else 'trash-can' }}
              x: 123
              "y": 39
              size: 50
              color: >-
                {{ 'red' if (([(14 if
                  states('sensor.days_to_restafval') in ['unknown', 'unavailable', 'none'] else states('sensor.days_to_restafval')),(14 if
                  states('sensor.days_to_papier') in ['unknown', 'unavailable', 'none'] else
                  states('sensor.days_to_papier')),(14 if
                  states('sensor.days_to_gft') in ['unknown', 'unavailable', 'none'] else
                  states('sensor.days_to_gft')) ]) | min ) | int < 2 else
                'black' }}

  update_study_climate_display:
    alias: "Update Study Climate Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.00000218736E3B1E
        data:
          background: white
          dry-run: false
          rotate: 270
          payload:
            # Desk
            - type: text
              value: "Temp:"
              font: ppb.ttf
              x: 1
              "y": 23
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_aqm_temperature') | round(1,default='NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 23
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "°C"
              font: ppb.ttf
              x: 90
              "y": 23
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: "Hum:"
              font: ppb.ttf
              x: 1
              "y": 45
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_multi_sensor_humidity') | int('NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 45
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "%"
              font: ppb.ttf
              x: 90
              "y": 45
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: "Press:"
              font: ppb.ttf
              x: 1
              "y": 67
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_aqm_pressure') | int(default='NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 67
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "hPa"
              font: ppb.ttf
              x: 90
              "y": 67
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: "CO2:" #Might be changed to CO₂ later. Currently the character is not included.
              font: ppb.ttf
              x: 1
              "y": 89
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_co2') | int('NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 89
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "ppm"
              font: ppb.ttf
              x: 90
              "y": 89
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: "PM1:"
              font: ppb.ttf
              x: 1
              "y": 111
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_pm_1_concentration') | int('NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 111
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "µg/m³"
              font: ppb.ttf
              x: 90
              "y": 111
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: "PM2.5:"
              font: ppb.ttf
              x: 1
              "y": 133
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_pm_2_5_concentration') | int('NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 133
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "µg/m³"
              font: ppb.ttf
              x: 90
              "y": 133
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: "PM10:"
              font: ppb.ttf
              x: 1
              "y": 155
              size: 12
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.study_pm_10_concentration') | int('NaN') }}"
              font: ppb.ttf
              x: 85
              "y": 155
              size: 16
              color: 'red'
              anchor: rb
            - type: text
              value: "µg/m³"
              font: ppb.ttf
              x: 90
              "y": 155
              size: 10
              color: 'black'
              anchor: lb

            - type: text
              value: " Update: {{ states('sensor.time') | string }} "
              font: ppb.ttf
              x: 1
              "y": 280
              size: 10
              color: 'black'
              anchor: lb
            # # Temperature
            # - type: text
            #   value: "Temperature:"
            #   font: ppb.ttf
            #   x: 10
            #   y: 10
            #   size: 18
            #   color: 'black'
            # - type: text
            #   value: "{{ states('sensor.study_aqm_temperature') | round(1,default='NaN') }}°C"
            #   font: ppb.ttf
            #   x: 180
            #   y: 10
            #   size: 24
            #   color: 'red'
            # # CO2
            # - type: text
            #   value: "CO2:"
            #   font: ppb.ttf
            #   x: 10
            #   y: 40
            #   size: 18
            #   color: 'black'
            # - type: text
            #   value: "{{ states('sensor.study_co2') | int }} ppm"
            #   font: ppb.ttf
            #   x: 180
            #   y: 40
            #   size: 24
            #   color: 'red'
            # # PM2.5
            # - type: text
            #   value: "PM2.5:"
            #   font: ppb.ttf
            #   x: 10
            #   y: 70
            #   size: 18
            #   color: 'black'
            # - type: text
            #   value: "{{ states('sensor.study_pm_2_5_concentration') | int }} µg/m³"
            #   font: ppb.ttf
            #   x: 180
            #   y: 70
            #   size: 24
            #   color: 'red'
            # # Update Time
            # - type: text
            #   value: "Last Update: {{ states('sensor.time') | string }}"
            #   font: ppb.ttf
            #   x: 10
            #   y: 100
            #   size: 14
            #   color: 'black'

  update_study_energy_display:
    alias: "Update Study Energy Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.0000039223703418
        data:
          background: white
          rotate: 0
          payload:
            # Desk
            - type: text
              value: "Desk:"
              font: ppb.ttf
              x: 3
              "y": 23
              size: 14
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.averaged_computer_power') | string }}"
              font: ppb.ttf
              x: 119
              "y": 23
              size: 30
              color: 'red'
              anchor: rb
            - type: text
              value: "w"
              font: ppb.ttf
              x: 141
              "y": 23
              size: 14
              color: 'black'
              anchor: rb
            # NAS
            - type: text
              value: "NAS:"
              font: ppb.ttf
              x: 3
              "y": 57
              size: 14
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.plug_nas_power') | string }}"
              font: ppb.ttf
              x: 119
              "y": 57
              size: 30
              color: 'red'
              anchor: rb
            - type: text
              value: "w"
              font: ppb.ttf
              x: 141
              "y": 57
              size: 14
              color: 'black'
              anchor: rb
            # Total energy
            - type: text
              value: "Total:"
              font: ppb.ttf
              x: 1
              "y": 90
              size: 14
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.daily_energy_use')|round(1,default='NaN') | string }}"
              font: ppb.ttf
              x: 118
              "y": 90
              size: 30
              color: 'red'
              anchor: rb
            - type: text
              value: "kWh"
              font: ppb.ttf
              x: 150
              "y": 90
              size: 14
              color: 'black'
              anchor: rb
              # Water
            - type: text
              value: "Water:"
              font: ppb.ttf
              x: 3
              "y": 128
              size: 14
              color: 'black'
              anchor: lb
            - type: text
              value: "{{ states('sensor.daily_water_use')|round(0,default='NaN') | string }}"
              font: ppb.ttf
              x: 119
              "y": 128
              size: 30
              color: 'red'
              anchor: rb
            - type: text
              value: "L"
              font: ppb.ttf
              x: 141
              "y": 128
              size: 14
              color: 'black'
              anchor: rb
              # Update
            - type: text
              value: " Update: {{ states('sensor.time') | string }} "
              font: ppb.ttf
              x: 150
              "y": 150
              size: 14
              color: 'black'
              anchor: rb

  update_precipitation_display:
    alias: "Update Precipitation Display"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: open_epaper_link.00007e225dd0b29c
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: plot_custom
              x_start: 10
              y_start: 10
              x_end: 344
              y_end: 150
              low: 0
              high: 20
              ylegend:
                position: right
                color: red
              yaxis:
                tick_width: 4
                grid: 5
              data:
                color: black
                width: 1
                joint: None
                x: "{{ state_attr('sensor.precipitation_forecast', 'precipitation_raw') | map(attribute='timestamp') | join(',') }}"
                y: "{{ state_attr('sensor.precipitation_forecast', 'precipitation_raw') | map(attribute='precipitation') | join(',') }}"

  update_moeke_water_tank_display:
    alias: "Update Moeke Water Tank Display"
    mode: queued
    fields:
      display_entity_id:
        description: "The entity ID of the display to be updated"
        example: "open_epaper_link.0000021DBCA73412"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: "{{ display_entity_id }}"
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              fill: >
                {{ 'white' if is_state('sensor.moeke_low_water_warning', 'no_warning') else 'red' }}
              outline: black
              width: 2
              x_start: 0
              y_start: 0
              x_end: 151
              y_end: 75
            - type: text
              value: "Dreame Status"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 10
              size: 16
              color: >
                {{ 'black' if is_state('sensor.moeke_low_water_warning', 'no_warning') else 'white' }}
            - type: text
              value: "{{ 'OK' if is_state('sensor.moeke_low_water_warning', 'no_warning') else 'NOK' }}"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 30
              size: 40
              color: >
                {{ 'black' if is_state('sensor.moeke_low_water_warning', 'no_warning') else 'white' }}
            - type: rectangle
              fill: >
                {{ 'white' if is_state('binary_sensor.moeke_reservoir_leak_sensor', 'on') else 'red' }}
              outline: black
              width: 2
              x_start: 0
              y_start: 76
              x_end: 151
              y_end: 151
            - type: text
              value: "Leak Status:"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 85
              size: 16
              color: >
                {{ 'black' if is_state('binary_sensor.moeke_reservoir_leak_sensor', 'on') else 'white' }}
            - type: text
              value: "{{ 'WET' if is_state('binary_sensor.moeke_reservoir_leak_sensor', 'on') else 'DRY' }}"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 110
              size: 40
              color: >
                {{ 'black' if is_state('binary_sensor.moeke_reservoir_leak_sensor', 'on') else 'white' }}

  update_litterbox_display:
    alias: "Update Litterbox Display"
    mode: queued
    fields:
      display_entity_id:
        description: "The entity ID of the display to be updated"
        example: "open_epaper_link.0000021D26A23414"
    sequence:
      - service: open_epaper_link.drawcustom
        target:
          entity_id: "{{ display_entity_id }}"
        data:
          background: white
          rotate: 0
          dry-run: false
          payload:
            - type: rectangle
              fill: >
                {{ 'red' if states('sensor.litterbox_total_counts') | int > 15 else 'white' }}
              outline: white
              width: 0
              x_start: 0
              y_start: 0
              x_end: 151
              y_end: 151
            - type: text
              value: "Total"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 10
              size: 20
              color: >
                {{ 'white' if states('sensor.litterbox_total_counts') | int > 15 else 'black' }}
            - type: text
              value: "{{ states('sensor.litterbox_total_counts') }}"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 40
              size: 30
              color: >
                {{ 'white' if states('sensor.litterbox_total_counts') | int > 15 else 'black' }}
            - type: text
              value: "Today"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 80
              size: 20
              color: >
                {{ 'white' if states('sensor.litterbox_total_counts') | int > 15 else 'black' }}
            - type: text
              value: "{{ states('sensor.litterbox_counts_today') }}"
              font: ppb.ttf
              anchor: mt
              x: 75
              y: 110
              size: 40
              color: >
                {{ 'white' if states('sensor.litterbox_total_counts') | int > 15 else 'black' }}
