#############################################################################################
################ DON'T FORGET TO CHANGE THE NOTIFICATION SERVICE IN LINE 50! ################
#############################################################################################


  #######################################################
  ### Sensor for unavailable entities, also good for UI.
  ### Updates immediately as soon as entities change.
  #######################################################

  template:
    - sensor:
        - name: "Unavailable Entities"
          state: "{{ expand('group.monitored_entities') | selectattr('state', 'in', ['unavailable', 'unknown', 'none']) | join(', ', attribute='attributes.friendly_name') | truncate(252) or 'Online' }}"
  
    #######################################################
    ### Helper
    #######################################################
  
  input_text:
    unavailable_entities_temp_state:
  
  automation:
    #######################################################
    ### Alert about entities becoming unavailable or online
    #######################################################
  
    - id: Unavailable Entities - Notify
      alias: Unavailable Entities - Notify
      variables:
        from_state: "{{ states('input_text.unavailable_entities_temp_state') }}"
        from_state_list: "{{ from_state.split(', ') }}"
        to_state: "{{ trigger.to_state.state if trigger.to_state.state != 'Online' else '' }}"
        to_state_list: "{{ to_state.split(', ') }}"
        became_online: "{{ from_state_list | reject('in', to_state_list) | join(', ') }}"
        became_unavailable_list: "{{ to_state_list | reject('in', from_state_list) | list }}"
        became_unavailable: "{{ became_unavailable_list | join(', ') }}"
        other_unavailable_entities: "{{ to_state_list | reject('in', became_unavailable_list) | join(', ') }}"
  
      trigger:
        - platform: state
          entity_id: sensor.unavailable_entities
  
          #Let other entities change as well so that we don't spam.
          #Has to be a minimum of 1 second, otherwise you won't get ONLINE notifications (because of the way I wrote this).
          for:
            seconds: 10
  
      action:
        - service: persistent_notification.create #Notifies me via telegram. Change this to your preferred service (such as: persistent_notification.create).
          data:
            notification_id: "unavailable_notification"
            message: |
              {% if became_unavailable != '' -%}ðŸš¨ Became <b>UNAVAILABLE</b>: {{ became_unavailable }}
              ------{%- endif %}
              {%- if became_online != ''%}
              âœ… Became <b>ONLINE</b>: {{ became_online }}
              ------{%- endif %}
              {% if other_unavailable_entities != '' %}ðŸš¨ Still <b>UNAVAILABLE</b>: {{ other_unavailable_entities }}{% else %}âœ… Everything else is ONLINE!{%- endif %}
  
        - service: input_text.set_value
          data:
            entity_id: input_text.unavailable_entities_temp_state
            value: ""
  
    #######################################################
    ### When entities start changing,
    ### store the initial state temporarily so that
    ### we could tell which entities have changes.
    #######################################################
  
    - id: Unavailable Entities - Store Temp State
      alias: Unavailable Entities - Store Temp State
  
      trigger:
        - platform: state
          entity_id: sensor.unavailable_entities
  
      condition:
        alias: "Temp State is Empty"
        condition: template
        value_template: "{{ is_state('input_text.unavailable_entities_temp_state', '') }}"
  
      action:
        service: input_text.set_value
        data:
          entity_id: input_text.unavailable_entities_temp_state
          value: "{{ '' if trigger.from_state.state == 'Online' else trigger.from_state.state }}"
  
  
  
    #######################################################
    ### Group of monitored entities.
    ### Add any entities you want to be notified about.
    #######################################################
  
  group:
    monitored_entities:
      entities:
        # - device_tracker.bed_scale
        # - device_tracker.blokmeister_hue
        - device_tracker.google_home_mini
        # - device_tracker.p1mon
        # - device_tracker.rockrobo
        - device_tracker.blitzwolf_3dprinter
        - device_tracker.blitzwolf_router
        - device_tracker.blitzwolf_computer
        - device_tracker.blitzwolf_eletricblanket
        - device_tracker.blitzwolf_mediacenter
        - device_tracker.blitzwolf_nuc
        - device_tracker.blitzwolf_plug1
        - device_tracker.blitzwolf_ambilight
        - device_tracker.blitzwolf_washing
        - device_tracker.blitzwolf_watercooker
        - device_tracker.blokmeisternuc
        - device_tracker.shelly_bathroom
        - device_tracker.shelly_bedroom
        - device_tracker.shelly_closet
        - device_tracker.shelly_dinnertable
        - device_tracker.shelly_entry
        - device_tracker.shelly_hallway
        - device_tracker.shelly_kitchen
        - device_tracker.shelly_study
        # - device_tracker.stardestroyerlights
        # - binary_sensor.entry_motion_combined
        # - binary_sensor.livingroom_motion_combined

        # Motion sensors:
        - binary_sensor.bathroom_motion_1
        - binary_sensor.bedroom_motion_1
        - binary_sensor.entry_motion_1
        - binary_sensor.entry_motion_2
        - binary_sensor.kitchen_motion_1
        - binary_sensor.kitchen_motion_2
        - binary_sensor.livingroom_motion_1
        - binary_sensor.livingroom_motion_2
        - binary_sensor.livingroom_motion_3
        # - binary_sensor.motion_sensor_livingroom3
        - binary_sensor.study_motion_1
        - binary_sensor.study_motion_2
        - binary_sensor.motion_sensor_toilet
        - binary_sensor.study_motion_combined
        # - binary_sensor.tapo_camera_d6d4_motion

        - binary_sensor.back_door_sensor
        - binary_sensor.entry_motion_combined
        - binary_sensor.front_door_sensor
        - binary_sensor.hallway_1st_floor_motion_1
        - binary_sensor.hallway_1st_floor_motion_2
        - binary_sensor.hallway_2nd_floor_motion_1
        - binary_sensor.hallway_2nd_floor_motion_2
        - binary_sensor.house_occupied
        - binary_sensor.livingroom_motion_combined
        - binary_sensor.meterkast_door_sensor
        - binary_sensor.moeke_reservoir_leak_sensor
        - binary_sensor.shower_occupied
        - binary_sensor.stairs_cabinet_door_sensor
        - binary_sensor.tamara_or_sander_downstairs
        - binary_sensor.vibration_sensor_mailbox
        - binary_sensor.washroom_door_sensor

        # Lights:
        - light.atmoorb_left
        - light.atmoorb_right
        - light.bedroom
        - light.entry_1
        - light.entry_2
        - light.entry_3
        - light.hallway_1st_floor_1
        - light.hallway_1st_floor_2
        - light.hallway_1st_floor_3
        - light.hallway_2nd_floor_1
        - light.hallway_2nd_floor_2
        - light.hallway_2nd_floor_3
        - light.study
        - light.study_1
        - light.study_2
        - light.study_3
        - light.study_4
        - light.study_5
        - light.study_candle
        - light.tamaras_room
        # - light.bedside_left
        # - light.bedside_right
        - light.hyperion_ambilightleft
        - light.hyperion_ambilightright
        - light.hyperion_apa102
        - light.kitchen
        - light.kitchen_1
        - light.kitchen_2
        - light.kitchen_3
        - light.shelly_closet
        - light.shelly_dinner_table
        - light.shelly_entry_light

        - switch.blitzwolf_3dprinter
        - switch.blitzwolf_ambilight
        - switch.blitzwolf_router
        - switch.blitzwolf_computer
        - switch.blitzwolf_computer_2
        - switch.blitzwolf_electricblanket
        - switch.blitzwolf_mediacenter_2
        - switch.blitzwolf_nuc
        - switch.blitzwolf_plug_1
        - switch.blitzwolf_washingmachine
        - switch.blitzwolf_watercooker
        - switch.blitzwolf_watercooker_2

        - sensor.humidity_bathroom

        - calendar.gasten_in_huis
        - device_tracker.samsung_tv
        - group.study_motion_sensors
        - input_boolean.garbagereminder
        - input_boolean.sleep_tracking_on
        - input_boolean.tamara_mode
        - media_player.coreelec
        - media_player.plex_plexkodiconnect_kodi_coreelec
        - media_player.tv_samsung_led55
        - sensor.last_triggered_motion_sensor
        - sensor.samba_backup
        - sensor.unavailable_entities
        - switch.shelly_closet
        - switch.shelly_kitchen
        - update.home_assistant_core_update
        - vacuum.alfred
        - vacuum.argus
        - vacuum.moeke

        - sensor.cheapest_night_price
        - sensor.energyzero_today_energy_lowest_price_time
        - sensor.heatpump_tapwater_temperature
        - sensor.moeke_error
        - sensor.moeke_low_water_warning
        - sensor.nordpool_energy_price
        - sensor.speedtest_download
        - sensor.temperature_fridge
        - sensor.unknown_power
        - sensor.last_triggered_motion_sensor
        - sensor.samba_backup
        - sensor.unavailable_entities

        # New device trackers
        - device_tracker.samsung_tv

        # New input booleans
        - input_boolean.garbagereminder
        - input_boolean.sleep_tracking_on
        - input_boolean.tamara_mode

        # New group
        - group.study_motion_sensors

        # Temperature Sensors
        - sensor.temperature_bathroom
        - sensor.temperature_bedroom
        - sensor.temperature_fridge
        - sensor.temperature_livingroom
        - sensor.temperature_outside
        - sensor.study_multi_sensor_temperature
        - sensor.study_multi_sensor_2_temperature
        - sensor.rabbits_temperature
