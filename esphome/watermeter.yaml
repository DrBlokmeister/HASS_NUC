substitutions:
  device_name: "Water Meter"
  espname: "watermeter"

esphome:
  name: '${espname}'
  comment: 'nodemcuv2'

esp8266:
  board: nodemcuv2
  restore_from_flash: true

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  use_address: 10.0.30.105
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: ${espname} Hotspot
    password: !secret esphome_fallback_pass

# Enable logging
logger:

# Enable Home Assistant API
api:
  services:
    - service: set_total
      variables:
        new_total: int
      then:
        - pulse_meter.set_total_pulses:
            id: pulse_meter_water_usage
            value: !lambda 'return new_total;'

# Enable OTA updates
ota:

# Enable Web server (optional).
web_server:
  port: 80

time:
  - platform: homeassistant
    id: homeassistant_time

button:
  - platform: restart
    id: restart_button
    name: "${device_name} Restart"

text_sensor:
  - platform: wifi_info
    ip_address:
      name: ${device_name} IP

sensor:
  # Uptime sensor.
  - platform: uptime
    name: ${device_name} Uptime

  # WiFi Signal sensor.
  - platform: wifi_signal
    name: ${device_name} WiFi Signal
    update_interval: 5s
    filters:
      - or:
        - throttle_average: 60s
        - delta: 5

  - platform: pulse_meter
    id: pulse_meter_water_usage
    name: Water Usage
    pin: D1
    timeout: 5 min
    unit_of_measurement: 'l/min'
    state_class: 'measurement'
    accuracy_decimals: 2
    icon: mdi:waves-arrow-right
    total:
      name: "Total Water"
      device_class: water
      state_class: 'measurement'
      accuracy_decimals: 0
      icon: mdi:water
